<!DOCTYPE html>

<html>

<head>
    <title>SIMAS - Sistem Manajemen Surat</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/res/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/res/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/res/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/res/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/res/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/res/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/res/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/res/favicon-16x16.png" sizes="16x16" />

    <!-- Stylesheet -->
    <link rel="stylesheet" href="/style/css/perfect-scrollbar.css">
    <link rel="stylesheet" href="/style/css/source-sans-pro.css">
    <link rel="stylesheet" href="/style/css/font-awesome.css">
    <link rel="stylesheet" href="/style/css/stylesheet.css">

    <!-- Javascript -->
    <script src="/style/js/vue.js"></script>
    <script src="/style/js/axios.js"></script>
    <script src="/style/js/lodash.js"></script>
    <script src="/style/js/moment.js"></script>
    <script src="/style/js/moment-id.js"></script>
    <script src="/style/js/js-cookie.js"></script>
    <script src="/style/js/perfect-scrollbar.js"></script>
</head>

<body>
    <div id="app" class="home" style="display: none">
        <div id="sidebar" :class="{visible: sidebar.visible}">
            <a id="close-sidebar" @click="sidebar.visible = false"><i class="fa fa-fw fa-times" aria-hidden="true"></i></a>
            <img id="logo" src="/res/logo.svg">
            <div id="link-container">
                <a id="btn-add" @click="btnAddAction" :class="{visible: btnAddVisible}">{{btnAddCaption}}</a>
                <template v-for="item in sidebar.item" v-if="item.visible">
                    <div v-if="item.hasSeparator" class="separator"></div>
                    <a class="sidebar-link" :class="{selected: sidebar.selected === item.value}" @click="selectSidebar(item.value)"><i class="fa fa-fw" :class="item.icon" aria-hidden="true"></i>{{item.caption}}<span v-if="item.count !== 0">{{item.count > 99 ? '99+' : item.count}}</span></a>
                </template>
            </div>
            <div id="user-area">
                <p>{{sidebar.account.nama}}<br>({{sidebar.account.jabatan}})</p>
                <div class="user-menu">
                    <a @click="showEditAkunAktif"><i class="fa fa-fw fa-pencil" aria-hidden="true"></i></a>
                    <a @click="showEditPassword"><i class="fa fa-fw fa-unlock-alt" aria-hidden="true"></i></a>
                    <a @click="showDialogLogout"><i class="fa fa-fw fa-sign-out" aria-hidden="true"></i></a>
                </div>
            </div>
        </div>
        <div id="content">
            <div id="page-list">
                <div id="search-area">
                    <a @click="sidebar.visible = true"><i class="fa fa-fw fa-bars" aria-hidden="true"></i></a>
                    <label for="txt-search"><i class="fa fa-fw fa-search" aria-hidden="true"></i></label>
                    <input type="text" :placeholder="searchHint" :value="pageList.keyword" @input="filterPageList">
                </div>
                <div id="item-list-area">
                    <p class="error-message" v-if="pageList.error.visible">{{pageList.error.message}}</p>
                    <p id="loading-list" v-if="pageList.loading"><i class="fa fa-spinner fa-spin fa-fw"></i></p>
                    <p id="empty-message" v-if="listEmpty">{{emptyMessage}}</p>
                    <template v-if="sidebar.selected === 4">
                        <div class="list-item account-item" v-for="(akun, idx) in pageList.item">
                            <p class="sub-caption">{{akun.jabatan}}</p>
                            <p class="main-caption">{{akun.nama}}<span class="admin" v-if="akun.admin === 1"></span><span class="penginput" v-if="akun.penginput === 1"></span></p>
                            <p class="info">{{akun.email}}<span v-if="akun.telepon !== ''">{{akun.telepon}}</span></p>
                            <div class="item-menu">
                                <a @click="showEditAkun(akun, idx)"><i class="fa fa-fw fa-pencil" aria-hidden="true"></i></a>
                                <a @click="showDeleteAkun(akun, idx)"><i class="fa fa-fw fa-trash" aria-hidden="true"></i></a>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="list-item inbox-item" v-for="(surat, idx) in pageList.item" :class="[statusClass(surat.status), {selected: pageList.selected === idx}, {new: surat.read === 0}]" @click="selectSurat(idx)">
                            <p class="sub-caption"><span v-if="surat.read === 0">New</span>{{surat.sumber}}</p>
                            <p class="main-caption">{{surat.perihal}}</p>
                            <p class="info">{{surat.nomor}}<span class="prioritas" :class="surat.prioritas | prioritasClass"></span><span class="tanggal">{{surat.tanggal | dateFormat('YYYY-MM-DD', 'DD MMM YYYY')}}</span></p>
                        </div>
                    </template>
                </div>
                <div id="pagination-area" v-if="pageList.maxPage > 1">
                    <a v-if="pageList.page > 2" @click="loadListItem(pageList.keyword, 1)"><i class="fa fa-fw fa-angle-double-left" aria-hidden="true"></i></a>
                    <a v-if="pageList.page > 1" @click="loadListItem(pageList.keyword, pageList.page - 1)"><i class="fa fa-fw fa-angle-left" aria-hidden="true"></i></a>
                    <input type="text" :value="pageList.page" @input="paginationChange">
                    <p>/</p>
                    <p>{{pageList.maxPage}}</p>
                    <a v-if="pageList.page < pageList.maxPage" @click="loadListItem(pageList.keyword, pageList.page + 1)"><i class="fa fa-fw fa-angle-right" aria-hidden="true"></i></a>
                    <a v-if="pageList.page < pageList.maxPage - 1" @click="loadListItem(pageList.keyword, pageList.maxPage)"><i class="fa fa-fw fa-angle-double-right" aria-hidden="true"></i></a>
                </div>
            </div>
            <div id="page-detail" v-if="pageDetail.visible">
                <p id="loading-detail" v-if="pageDetail.loading"><i class="fa fa-spinner fa-spin fa-fw"></i></p>
                <div id="detail-header" v-if="pageDetail.surat.id !== ''">
                    <a id="btn-back" @click="closePageDetail"><i class="fa fa-fw fa-arrow-left" aria-hidden="true"></i></a>
                    <p id="header-perihal">{{pageDetail.surat.perihal}}</p>
                    <div id="header-menu" v-if="sidebar.selected === 5 && sidebar.account.penginput === 1">
                        <a @click="showEditSurat"><i class="fa fa-fw fa-pencil" aria-hidden="true"></i></a>
                        <a @click="showDeleteSurat"><i class="fa fa-fw fa-trash" aria-hidden="true"></i></a>
                    </div>
                </div>
                <div id="detail-content" v-if="pageDetail.surat.id !== ''">
                    <div class="detail-data">
                        <div>
                            <p class="label">Nomor surat</p>
                            <p class="value">{{pageDetail.surat.nomor}}</p>
                        </div>
                        <div>
                            <p class="label">Tanggal surat</p>
                            <p class="value">{{pageDetail.surat.tanggal | dateFormat('YYYY-MM-DD', 'DD MMMM YYYY')}}</p>
                        </div>
                        <div>
                            <p class="label">Sumber surat</p>
                            <p class="value">{{pageDetail.surat.sumber}}</p>
                        </div>
                        <div>
                            <p class="label">Tujuan surat</p>
                            <p class="value">{{pageDetail.surat.tujuan}}<span class="jabatan">{{pageDetail.surat.jabatan}}</span></p>
                        </div>
                        <div>
                            <p class="label">Waktu terima</p>
                            <p class="value">{{pageDetail.surat.waktuTerima | dateFormat('YYYY-MM-DD HH:mm:ss', 'DD MMMM YYYY [jam] HH:mm') | replace(' jam 00:00', '')}}</p>
                        </div>
                        <div>
                            <p class="label">Prioritas</p>
                            <p class="value prioritas" :class="pageDetail.surat.prioritas | prioritasClass">{{pageDetail.surat.prioritas | prioritasClass}}</p>
                        </div>
                        <div>
                            <p class="label">Status</p>
                            <p class="value" :class="statusClass(pageDetail.disposisi.status)">{{pageDetail.disposisi.status | statusName}}</p>
                        </div>
                        <div v-if="pageDetail.files.length > 0">
                            <p class="label">File surat</p>
                            <div class="value file-list">
                                <a @click="showLightbox(file)" v-for="(file, idx) in pageDetail.files">{{file}}</a>
                            </div>
                        </div>
                    </div>
                    <div class="detail-data" id="data-disposisi" v-if="sidebar.selected !== 5 && pageDetail.surat.id !== '' && pageDetail.disposisi.parentId != null">
                        <div>
                            <p class="label">Sumber disposisi</p>
                            <p class="value">{{pageDetail.disposisi.sumber}}<span class="jabatan">{{pageDetail.disposisi.jabatan}}</span></p>
                        </div>
                        <div>
                            <p class="label">Waktu disposisi</p>
                            <p class="value">{{pageDetail.disposisi.waktu | dateFormat('YYYY-MM-DD HH:mm:ss', 'DD MMMM YYYY [jam] HH:mm:ss') | replace('jam 00:00:00', '')}}</p>
                        </div>
                        <div>
                            <p class="label">Keterangan</p>
                            <pre class="value">{{pageDetail.disposisi.deskripsi === '' ? '-' : pageDetail.disposisi.deskripsi}}</pre>
                        </div>
                    </div>
                    <div class="timeline" v-if="sidebar.selected !== 5">
                        <timeline-item v-for="item in pageDetail.timeline" :id="item.id" :tujuan="item.tujuan" :jabatan="item.jabatan" :waktu="item.waktu" :status="item.status" :children="item.children" @disposisi-click="showDialogDisposisi" @diarsip-click="showDialogDiarsip" @ditindak-click="showDialogDitindak">
                        </timeline-item>
                        <div class="timeline-act" v-if="pageDetail.disposisi.status === 0">
                            <a class="disposisi" @click="showDialogDisposisi(pageDetail.disposisi.id)"></a>
                            <a v-if="pageDetail.timeline.length === 0" class="diarsip" @click="showDialogDiarsip"></a>
                            <a v-if="pageDetail.timeline.length === 0" class="ditindak" @click="showDialogDitindak"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="loading-overlay" v-if="loadingOverlayVisible"></div>
        <div id="dialog-overlay" v-if="dialogOverlayVisible" @keyup.esc="closeDialog" @click="closeTujuanSuggestion">
            <div class="dialog" id="dialog-input-surat" v-if="inputSurat.visible">
                <p class="header">{{inputSurat.isNew ? 'Surat Baru' : 'Edit Surat'}}</p>
                <p class="error-message" v-if="inputSurat.error.visible">{{inputSurat.error.message}}</p>
                <div class="field">
                    <label>Nomor surat</label>
                    <input tabindex="1" ref="txtNomorSurat" type="text" placeholder="Nomor surat" v-model.trim="inputSurat.field.nomor" @keyup.enter="simpanSurat">
                </div>
                <div class="field">
                    <label>Perihal</label>
                    <input tabindex="2" type="text" placeholder="Perihal" v-model.trim="inputSurat.field.perihal" @keyup.enter="simpanSurat">
                </div>
                <div class="field">
                    <label>Sumber surat</label>
                    <input tabindex="3" type="text" placeholder="Sumber surat" v-model.trim="inputSurat.field.sumber" @keyup.enter="simpanSurat">
                </div>
                <div class="field" v-if="inputSurat.isNew">
                    <label>Tujuan surat</label>
                    <input tabindex="4" type="text" placeholder="Nama tujuan surat" :value="inputSurat.field.tujuan" @input="getTujuanSuggestion" @keyup.enter="selectTujuanSuggestion(0)" @keyup.down="focusTujuanSuggestion(0)">
                    <div class="suggestion" v-if="inputSurat.suggestion.loading || inputSurat.suggestion.item.length > 0">
                        <p class="loading" v-if="inputSurat.suggestion.loading"><i class="fa fa-spinner fa-spin fa-fw"></i></p>
                        <div ref="tujuanSuggestionItem" class="suggestion-item" v-for="(account, idx) in inputSurat.suggestion.item" :tabindex="5 + idx" @keyup.up="focusTujuanSuggestion(idx - 1)" @keyup.down="focusTujuanSuggestion(idx + 1)" @keyup.enter="selectTujuanSuggestion(idx)" @click="selectTujuanSuggestion(idx)">
                            <p class="main">{{account.nama}}</p>
                            <p class="info">{{account.jabatan}}</p>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label>Tanggal surat</label>
                    <input :tabindex="5 + inputSurat.suggestion.item.length" ref="txtTanggalSurat" type="text" placeholder="Tanggal surat" v-model.trim="inputSurat.field.tanggal" @focus="closeTujuanSuggestion" @keyup.enter="simpanSurat">
                </div>
                <div class="field">
                    <label>Waktu terima</label>
                    <input :tabindex="6 + inputSurat.suggestion.item.length" type="text" placeholder="Waktu terima" v-model.trim="inputSurat.field.waktuTerima" @keyup.enter="simpanSurat">
                </div>
                <div class="field">
                    <label>Prioritas</label>
                    <div class="choice-area">
                        <div class="choice-item">
                            <input :tabindex="7 + inputSurat.suggestion.item.length" name="prioritas" id="choice-biasa" type="radio" value="0" v-model="inputSurat.field.prioritas">
                            <label for="choice-biasa">Biasa</label>
                        </div>
                        <div class="choice-item">
                            <input :tabindex="7 + inputSurat.suggestion.item.length" name="prioritas" id="choice-segera" type="radio" value="1" v-model="inputSurat.field.prioritas">
                            <label for="choice-segera">Segera</label>
                        </div>
                        <div class="choice-item">
                            <input :tabindex="7 + inputSurat.suggestion.item.length" name="prioritas" id="choice-penting" type="radio" value="2" v-model="inputSurat.field.prioritas">
                            <label for="choice-penting">Penting</label>
                        </div>
                        <div class="choice-item">
                            <input :tabindex="7 + inputSurat.suggestion.item.length" name="prioritas" id="choice-rahasia" type="radio" value="3" v-model="inputSurat.field.prioritas">
                            <label for="choice-rahasia">Rahasia</label>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label>File surat</label>
                    <div class="file-picker-area">
                        <input ref="inputFileSurat" type="file" accept="image/jpeg,image/png" multiple @change="fileSuratPickerChange">
                        <div class="file-list" v-if="inputSurat.field.files.length > 0">
                            <p v-for="(file, idx) in inputSurat.field.files" v-if="!file.isDeleted" @click="showDeleteFileSurat(idx)">{{file.blob ? file.blob.name : file.name}}</p>
                        </div>
                        <a :tabindex="8 + inputSurat.suggestion.item.length" v-if="inputSurat.field.files.length < 5" @click="showFileSuratPicker" @keyup.enter="showFileSuratPicker">Lampirkan file (maksimal 5 file JPG atau PNG)</a>
                    </div>
                </div>
                <div class="footer">
                    <a :tabindex="10 + inputSurat.suggestion.item.length" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a :tabindex="9 + inputSurat.suggestion.item.length" class="main-button" @click="simpanSurat" @keyup.enter="simpanSurat">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-input-akun" v-if="inputAkun.visible">
                <p class="header">{{inputAkun.isNew ? 'Akun Baru' : 'Edit Akun'}}</p>
                <p class="error-message" v-if="inputAkun.error.visible">{{inputAkun.error.message}}</p>
                <div class="field">
                    <label>Nama</label>
                    <input tabindex="1" ref="txtNamaAkun" type="text" placeholder="Nama pemilik akun" v-model.trim="inputAkun.field.nama" @keyup.enter="simpanAkun">
                </div>
                <div class="field">
                    <label>Email</label>
                    <input tabindex="2" type="text" placeholder="Email untuk login" v-model.trim="inputAkun.field.email" @keyup.enter="simpanAkun">
                </div>
                <div class="field">
                    <label>Jabatan</label>
                    <input tabindex="3" type="text" placeholder="Jabatan pemilik akun" v-model.trim="inputAkun.field.jabatan" @keyup.enter="simpanAkun">
                </div>
                <div class="field">
                    <label>Telepon</label>
                    <input tabindex="4" type="text" placeholder="Nomor telepon pemilik akun" v-model.trim="inputAkun.field.telepon" @keyup.enter="simpanAkun">
                </div>
                <div class="field">
                    <label>Admin</label>
                    <div class="choice-area">
                        <div class="choice-item">
                            <input tabindex="5" name="admin" id="choice-admin-no" type="radio" value="0" v-model="inputAkun.field.admin">
                            <label for="choice-admin-no">Tidak</label>
                        </div>
                        <div class="choice-item">
                            <input tabindex="5" name="admin" id="choice-admin-yes" type="radio" value="1" v-model="inputAkun.field.admin">
                            <label for="choice-admin-yes">Ya</label>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label>Penginput surat</label>
                    <div class="choice-area">
                        <div class="choice-item">
                            <input tabindex="6" name="penginput" id="choice-penginput-no" type="radio" value="0" v-model="inputAkun.field.penginput">
                            <label for="choice-penginput-no">Tidak</label>
                        </div>
                        <div class="choice-item">
                            <input tabindex="6" name="penginput" id="choice-penginput-yes" type="radio" value="1" v-model="inputAkun.field.penginput">
                            <label for="choice-penginput-yes">Ya</label>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <a tabindex="8" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a tabindex="7" class="main-button" @click="simpanAkun" @keyup.enter="simpanAkun">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-disposisi" v-if="dialogDisposisi.visible" @click="closeDisposisiSuggestion">
                <p class="header">Disposisi Surat</p>
                <p class="error-message" v-if="dialogDisposisi.error.visible">{{dialogDisposisi.error.message}}</p>
                <div class="field">
                    <label>Nama tujuan</label>
                    <input tabindex="1" ref="txtNamaTujuan" type="text" placeholder="Nama tujuan disposisi" :value="dialogDisposisi.field.tujuan" @input="getDisposisiSuggestion" @keyup.enter="selectDisposisiSuggestion(0)" @keyup.down="focusDisposisiSuggestion(0)">
                    <div class="suggestion" v-if="dialogDisposisi.suggestion.loading || dialogDisposisi.suggestion.item.length > 0">
                        <p class="loading" v-if="dialogDisposisi.suggestion.loading"><i class="fa fa-spinner fa-spin fa-fw"></i></p>
                        <div ref="disposisiSuggestionItem" class="suggestion-item" v-for="(account, idx) in dialogDisposisi.suggestion.item" :tabindex="2 + idx" @keyup.up="focusDisposisiSuggestion(idx - 1)" @keyup.down="focusDisposisiSuggestion(idx + 1)" @keyup.enter="selectDisposisiSuggestion(idx)" @click="selectDisposisiSuggestion(idx)">
                            <p class="main">{{account.nama}}</p>
                            <p class="info">{{account.jabatan}}</p>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label>Keterangan</label>
                    <textarea :tabindex="2 + dialogDisposisi.suggestion.item.length" ref="txtKeteranganDisposisi" type="text" placeholder="Keterangan" v-model.trim="dialogDisposisi.field.deskripsi" @focus="closeDisposisiSuggestion"></textarea>
                </div>
                <div class="footer">
                    <a :tabindex="4 + dialogDisposisi.suggestion.item.length" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a :tabindex="3 + dialogDisposisi.suggestion.item.length" class="main-button" @click="simpanDisposisi" @keyup.enter="simpanDisposisi">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-diarsip" v-if="dialogDiarsip.visible">
                <p class="header">Arsipkan Surat</p>
                <p class="error-message" v-if="dialogDiarsip.error.visible">{{dialogDiarsip.error.message}}</p>
                <div class="field">
                    <label>Waktu</label>
                    <input tabindex="1" ref="txtWaktuDiarsip" type="text" placeholder="Tanggal dan jam surat diarsipkan" v-model.trim="dialogDiarsip.field.waktu" @keyup.enter="simpanDiarsip">
                </div>
                <div class="footer">
                    <a tabindex="3" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a tabindex="2" class="main-button" @click="simpanDiarsip" @keyup.enter="simpanDiarsip">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-ditindak" v-if="dialogDitindak.visible">
                <p class="header">Tindaklanjuti Surat</p>
                <p class="error-message" v-if="dialogDitindak.error.visible">{{dialogDitindak.error.message}}</p>
                <div class="field">
                    <label>Waktu</label>
                    <input tabindex="1" ref="txtWaktuDitindak" type="text" placeholder="Tanggal dan jam surat ditindaklanjuti" v-model.trim="dialogDitindak.field.waktu" @keyup.enter="simpanDitindak">
                </div>
                <div class="footer">
                    <a tabindex="3" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a tabindex="2" class="main-button" @click="simpanDitindak" @keyup.enter="simpanDitindak">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-edit-password" v-if="editPassword.visible">
                <p class="header">Ubah Password</p>
                <p class="error-message" v-if="editPassword.error.visible">{{editPassword.error.message}}</p>
                <div class="field">
                    <label>Password lama</label>
                    <input tabindex="1" ref="txtPasswordLama" type="password" placeholder="Password lama" v-model.trim="editPassword.field.passwordLama" @keyup.enter="simpanPassword">
                </div>
                <div class="field">
                    <label>Password baru</label>
                    <input tabindex="2" type="password" placeholder="Password baru" v-model.trim="editPassword.field.password" @keyup.enter="simpanPassword">
                </div>
                <div class="field">
                    <label>Ulangi password</label>
                    <input tabindex="3" type="password" placeholder="Ulangi lagi password yang baru" v-model.trim="editPassword.field.ulangPassword" @keyup.enter="simpanPassword">
                </div>
                <div class="footer">
                    <a tabindex="5" @click="closeDialog" @keyup.enter="closeDialog">Batal</a>
                    <a tabindex="4" class="main-button" @click="simpanPassword" @keyup.enter="simpanPassword">Simpan</a>
                </div>
            </div>
            <div class="dialog" id="dialog-message" v-if="dialog.visible">
                <p class="header">{{dialog.title}}</p>
                <p class="message">{{dialog.message}}</p>
                <div class="footer" :class="{loading: dialog.loading}">
                    <a tabindex="2" @click="dialog.subAction" @keyup.enter="dialog.subAction" v-if="dialog.subCaption !== ''">{{dialog.subCaption}}</a>
                    <a tabindex="1" ref="mainDialogButton" class="main-button" @click="dialog.mainAction" @keyup.enter="dialog.mainAction">{{dialog.mainCaption}}</a>
                </div>
            </div>
        </div>
        <div ref="lightbox" id="lightbox" v-if="lightbox.visible" @keyup.esc="closeLightbox" tabindex="0">
            <p v-if="lightbox.loading" id="lightbox-loading"><i class="fa fa-spinner fa-spin fa-fw"></i></p>
            <p v-if="lightbox.error" id="lightbox-error">Gagal mengambil gambar</p>
            <a id="lightbox-close" @click="closeLightbox"><i class="fa fa-fw fa-times" aria-hidden="true"></i></a>
            <img v-show="!lightbox.error" :src="lightbox.data" @load="lightboxLoaded" @error="lightboxError" @keyup.esc="closeLightbox">
        </div>
    </div>

    <script type="text/x-template" id="timeline-item">
        <div class="timeline-item" :class="statusClass">
            <div class="timeline-content">
                <p class="time">{{waktuAksi}}</p>
                <p class="value">{{statusMessage}} <span>{{tujuan}}</span></p>
                <p class="jabatan">{{jabatan}}</p>
            </div>
            <div class="timeline">
                <timeline-item v-for="child in children" :id="child.id" :tujuan="child.tujuan" :jabatan="child.jabatan" :waktu="child.waktu" :status="child.status" :children="child.children">
                </timeline-item>
            </div>
        </div>
    </script>

    <script>
        // Set locale
        moment.locale('id');

        // Parse token
        var token = Cookies.get('token');

        if (token == null) {
            location.href = '/login';
        }

        var payload = token.split('.')[1],
            decoded = atob(payload),
            payloadData = JSON.parse(decoded);

        // Parse account data
        var account;
        if (localStorage.getItem('account') !== null) {
            account = JSON.parse(localStorage.getItem('account'));
        } else if (sessionStorage.getItem('account') !== null) {
            account = JSON.parse(sessionStorage.getItem('account'));
        } else {
            location.href = '/login';
        }

        // Register component
        Vue.component('timeline-item', {
            template: '#timeline-item',
            props: {
                id: Number,
                tujuan: String,
                jabatan: String,
                waktu: String,
                status: Number,
                children: Array
            },
            computed: {
                statusClass: function() {
                    if (this.status === 2) return 'ditindak';
                    else if (this.status === 1) return 'diarsip';
                    else return 'disposisi';
                },
                statusMessage: function() {
                    if (this.status === 2) return 'Ditindaklanjuti oleh';
                    else if (this.status === 1) return 'Diarsipkan oleh';
                    else return 'Didisposisikan ke';
                },
                waktuAksi: function() {
                    return moment.utc(this.waktu, 'YYYY-MM-DD HH:mm:ss')
                        .local()
                        .format('DD MMMM YYYY [jam] HH:mm')
                        .replace(' jam 00:00', '');
                }
            }
        });

        // Register app
        var app = new Vue({
            el: '#app',
            data: {
                sidebar: {
                    visible: false,
                    selected: 0,
                    item: [{
                        value: 0,
                        hasSeparator: false,
                        caption: 'Semua Surat',
                        icon: 'fa-inbox',
                        visible: true,
                        count: 0
                    }, {
                        value: 1,
                        hasSeparator: false,
                        caption: 'Dalam Proses',
                        icon: 'fa-clock-o',
                        visible: true,
                        count: 0
                    }, {
                        value: 2,
                        hasSeparator: false,
                        caption: 'Diarsipkan',
                        icon: 'fa-folder',
                        visible: true,
                        count: 0
                    }, {
                        value: 3,
                        hasSeparator: false,
                        caption: 'Ditindaklanjuti',
                        icon: 'fa-check-circle',
                        visible: true,
                        count: 0
                    }, {
                        value: 4,
                        hasSeparator: true,
                        caption: 'Kelola Akun',
                        icon: 'fa-users',
                        visible: payloadData.admin,
                        count: 0
                    }, {
                        value: 5,
                        hasSeparator: !payloadData.admin,
                        caption: 'Kelola Surat',
                        icon: 'fa-envelope',
                        visible: payloadData.input,
                        count: 0
                    }],
                    account: {
                        id: payloadData.sub,
                        nama: account.nama,
                        email: account.email,
                        jabatan: account.jabatan,
                        telepon: account.telepon,
                        admin: payloadData.admin ? 1 : 0,
                        penginput: payloadData.input ? 1 : 0
                    }
                },
                pageList: {
                    loading: false,
                    page: 1,
                    maxPage: 1,
                    keyword: '',
                    item: [],
                    selected: 0,
                    error: {
                        visible: false,
                        message: ''
                    }
                },
                pageDetail: {
                    loading: false,
                    visible: false,
                    surat: {
                        id: 0,
                        nomor: '',
                        perihal: '',
                        sumber: '',
                        tujuan: '',
                        jabatan: '',
                        tanggal: '',
                        waktuTerima: '',
                        prioritas: 0,
                        status: 0
                    },
                    disposisi: {
                        id: 0,
                        parentId: 0,
                        sumberId: 0,
                        sumber: '',
                        jabatan: '',
                        waktu: '',
                        status: 0,
                        deskripsi: ''
                    },
                    files: [],
                    timeline: []
                },
                inputSurat: {
                    visible: false,
                    isNew: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        id: 0,
                        nomor: '',
                        perihal: '',
                        sumber: '',
                        tujuanId: 0,
                        tujuan: '',
                        tanggal: '',
                        waktuTerima: '',
                        prioritas: 0,
                        files: []
                    },
                    suggestion: {
                        loading: false,
                        item: []
                    }
                },
                inputAkun: {
                    visible: false,
                    isNew: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        id: 0,
                        nama: '',
                        email: '',
                        jabatan: '',
                        telepon: '',
                        admin: 0,
                        penginput: 0,
                        index: -1
                    }
                },
                dialogDisposisi: {
                    visible: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        parentId: 0,
                        tujuanId: 0,
                        tujuan: '',
                        deskripsi: ''
                    },
                    suggestion: {
                        loading: false,
                        item: []
                    }
                },
                dialogDiarsip: {
                    visible: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        id: '',
                        waktu: ''
                    }
                },
                dialogDitindak: {
                    visible: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        id: '',
                        waktu: ''
                    }
                },
                editPassword: {
                    visible: false,
                    error: {
                        visible: false,
                        message: ''
                    },
                    field: {
                        id: 0,
                        passwordLama: '',
                        password: '',
                        ulangPassword: ''
                    }
                },
                lightbox: {
                    visible: false,
                    loading: false,
                    error: true,
                    data: ''
                },
                dialog: {
                    visible: false,
                    loading: false,
                    title: '',
                    message: '',
                    mainCaption: '',
                    subCaption: '',
                    mainAction: function() {},
                    subAction: function() {}
                }
            },
            computed: {
                btnAddVisible: function() {
                    if (this.sidebar.selected < 4) return false;
                    return true;
                },
                btnAddCaption: function() {
                    if (this.sidebar.selected === 4) return 'Akun Baru';
                    else if (this.sidebar.selected === 5) return 'Surat Baru';
                },
                btnAddAction: function() {
                    if (this.sidebar.selected === 4) return this.showInputAkun;
                    else return this.showInputSurat;
                },
                searchHint: function() {
                    if (this.sidebar.selected === 4) return 'Cari nama, email dan jabatan akun';
                    else return 'Cari nomor surat, perihal, sumber dan pengirim surat';
                },
                emptyMessage: function() {
                    if (this.sidebar.selected === 4) return 'Tidak ada akun yang terdaftar';
                    else return 'Tidak ada surat yang terdaftar';
                },
                loadingOverlayVisible: function() {
                    return this.pageList.loading ||
                        this.pageDetail.loading ||
                        this.inputSurat.suggestion.loading ||
                        this.dialogDisposisi.suggestion.loading;
                },
                dialogOverlayVisible: function() {
                    return this.inputSurat.visible ||
                        this.inputAkun.visible ||
                        this.dialogDisposisi.visible ||
                        this.dialogDiarsip.visible ||
                        this.dialogDitindak.visible ||
                        this.editPassword.visible ||
                        this.dialog.visible;
                },
                listEmpty: function() {
                    return !this.pageList.loading && this.pageList.item.length === 0;
                },
                currentKeyword: function() {
                    return this.pageList.keyword;
                },
                currentPage: function() {
                    return this.pageList.page;
                }
            },
            filters: {
                statusName: function(status) {
                    if (status === 3) return 'Ditindaklanjuti dan diarsipkan';
                    else if (status === 2) return 'Ditindaklanjuti';
                    else if (status === 1) return 'Diarsipkan';
                    else return 'Dalam proses';
                },
                prioritasClass: function(prioritas) {
                    if (prioritas === 3) return 'rahasia';
                    else if (prioritas === 2) return 'penting';
                    else if (prioritas === 1) return 'segera';
                    else return 'biasa';
                },
                dateFormat: function(src, srcFormat, resFormat) {
                    return moment(src, srcFormat).format(resFormat);
                },
                replace: function(src, old, replacement) {
                    return src.replace(old, replacement);
                }
            },
            methods: {
                logout: function() {
                    Cookies.remove('token');
                    localStorage.removeItem('account');
                    sessionStorage.removeItem('account');
                    location.href = '/login';
                },
                statusClass: function(status) {
                    if (status === 3) return 'ditindak-diarsip';
                    else if (status === 2) return 'ditindak';
                    else if (status === 1) return 'diarsip';
                    else return 'diproses';
                },
                selectSidebar: function(value) {
                    this.sidebar.selected = value;
                    this.sidebar.visible = false;
                    this.loadListItem();
                },
                loadListItem: function(keyword, page) {
                    this.pageList.loading = true;
                    this.pageList.page = parseInt(page, 10) || 1;
                    this.pageList.maxPage = 1;
                    this.pageList.item = [];
                    this.pageList.keyword = keyword ? keyword : '';
                    this.pageList.error.visible = false;
                    this.closePageDetail();

                    var apiURL = '/api/surat?';
                    if (this.sidebar.selected === 5) apiURL = '/api/surat?kelola';
                    else if (this.sidebar.selected === 4) apiURL = '/api/account?';
                    else if (this.sidebar.selected === 3) apiURL = '/api/surat?ditindak';
                    else if (this.sidebar.selected === 2) apiURL = '/api/surat?diarsip';
                    else if (this.sidebar.selected === 1) apiURL = '/api/surat?diproses';

                    apiURL += '&page=' + encodeURI(this.pageList.page);

                    if (keyword != null && keyword !== '') {
                        apiURL += '&keyword=' + encodeURI(keyword);
                    }

                    axios(apiURL).then(function(response) {
                        app.pageList.loading = false;
                        app.pageList.page = response.data.page;
                        app.pageList.maxPage = response.data.maxPage;
                        app.pageList.item = response.data.item;

                        console.log(JSON.stringify(response.data, '', '  '));

                        if (response.data.newCount) {
                            var nTotal = 0,
                                nDiproses = 0,
                                nDiarsip = 0,
                                nDitindak = 0;

                            response.data.newCount.forEach(function(data) {
                                nTotal += data.count;
                                if (data.status === 0) nDiproses += data.count;
                                else if (data.status === 1) nDiarsip += data.count;
                                else if (data.status === 2) nDitindak += data.count;
                                else if (data.status === 3) {
                                    nDiarsip += data.count;
                                    nDitindak += data.count;
                                }
                            });

                            app.sidebar.item[0].count = nTotal;
                            app.sidebar.item[1].count = nDiproses;
                            app.sidebar.item[2].count = nDiarsip;
                            app.sidebar.item[3].count = nDitindak;
                        }

                        var listArea = document.getElementById('item-list-area');
                        if (listArea.className.indexOf('ps-container') === -1) {
                            Ps.initialize(listArea);
                        } else {
                            listArea.scrollTop = 0;
                            Ps.update(listArea);
                        }
                    }).catch(function(error) {
                        var message;
                        if (error.response) message = error.response.data;
                        else message = error.message;

                        app.pageList.loading = false;
                        app.pageList.error.visible = true;
                        app.pageList.error.message = message;
                    });
                },
                showInputSurat: function() {
                    this.sidebar.visible = false;
                    this.inputSurat.visible = true;
                    this.inputSurat.isNew = true;
                    this.inputSurat.error.visible = false;
                    this.inputSurat.field.nomor = '';
                    this.inputSurat.field.perihal = '';
                    this.inputSurat.field.sumber = '';
                    this.inputSurat.field.tujuanId = 0;
                    this.inputSurat.field.tujuan = '';
                    this.inputSurat.field.tanggal = '';
                    this.inputSurat.field.waktuTerima = '';
                    this.inputSurat.field.prioritas = 0;
                    this.inputSurat.field.files = [];

                    this.$nextTick(function() {
                        this.$refs.txtNomorSurat.focus();
                    });
                },
                showEditSurat: function() {
                    var tanggal = moment(this.pageDetail.surat.tanggal, 'YYYY-MM-DD').format('DD-MM-YYYY'),
                        waktuTerima = moment(this.pageDetail.surat.waktuTerima, 'YYYY-MM-DD HH:mm:ss').format('DD-MM-YYYY HH:mm:ss');

                    var exisitingFiles = [];
                    this.pageDetail.files.forEach(function(file) {
                        exisitingFiles.push({
                            name: file,
                            isNew: false,
                            isDeleted: false
                        });
                    });

                    this.inputSurat.visible = true;
                    this.inputSurat.isNew = false;
                    this.inputSurat.error.visible = false;
                    this.inputSurat.field.id = this.pageDetail.surat.id;
                    this.inputSurat.field.nomor = this.pageDetail.surat.nomor;
                    this.inputSurat.field.perihal = this.pageDetail.surat.perihal;
                    this.inputSurat.field.sumber = this.pageDetail.surat.sumber;
                    this.inputSurat.field.tujuanId = 0;
                    this.inputSurat.field.tujuan = '';
                    this.inputSurat.field.tanggal = tanggal;
                    this.inputSurat.field.waktuTerima = waktuTerima.replace(' 00:00:00', '');
                    this.inputSurat.field.prioritas = this.pageDetail.surat.prioritas;
                    this.inputSurat.field.files = exisitingFiles;

                    this.$nextTick(function() {
                        this.$refs.txtNomorSurat.focus();
                    });
                },
                showDeleteSurat: function() {
                    var index = this.pageList.selected,
                        idSurat = this.pageDetail.surat.id,
                        nomorSurat = this.pageDetail.surat.nomor;

                    this.dialog.visible = true;
                    this.dialog.title = 'Hapus Surat';
                    this.dialog.message = 'Yakin ingin menghapus surat dengan nomor ' + nomorSurat + ' ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;
                        axios.delete('/api/surat/' + idSurat)
                            .then(function() {
                                app.dialog.loading = false;
                                app.pageList.item.splice(index, 1);
                                app.closePageDetail();
                                app.closeDialog();
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.loading = false;
                                app.dialog.title = 'Error';
                                app.dialog.message = 'Gagal menghapus data surat. ' + message;
                                app.dialog.subCaption = '';
                                app.dialog.mainCaption = 'OK';
                                app.dialog.mainAction = app.closeDialog;

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                showFileSuratPicker: function() {
                    this.inputSurat.error.visible = false;
                    this.$refs.inputFileSurat.click();
                },
                fileSuratPickerChange: function() {
                    var files = this.$refs.inputFileSurat.files,
                        nExistingFile = this.inputSurat.field.files.length,
                        nNewFile = files.length,
                        error = false,
                        errorMessage = '',
                        newFilesArray = [];

                    if (nExistingFile + nNewFile > 5) {
                        error = true;
                        errorMessage = 'Jumlah file maksimal lima gambar';
                    } else {
                        for (var i = 0; i < files.length; i++) {
                            if (files[i].type !== 'image/jpeg' && files[i].type !== 'image/png') {
                                error = true;
                                errorMessage = 'File harus berupa gambar dengan format JPG atau PNG';
                                break;
                            }

                            if (files[i].size > 5000000) {
                                error = true;
                                errorMessage = 'File maksimal berukuran 5 MB';
                                break;
                            }

                            newFilesArray.push({
                                blob: files[i],
                                isNew: true,
                                isDeleted: false
                            });
                        }
                    }

                    if (error) {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = errorMessage;
                        return;
                    }

                    this.inputSurat.field.files = this.inputSurat.field.files.concat(newFilesArray);
                },
                showDeleteFileSurat: function(index) {
                    var file = this.inputSurat.field.files[index],
                        fileName = file.blob ? file.blob.name : file.name;

                    this.inputSurat.visible = false;
                    this.dialog.visible = true;
                    this.dialog.title = 'Hapus File';
                    this.dialog.message = 'Yakin ingin menghapus file ' + fileName + ' ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                        app.inputSurat.visible = true;
                    };
                    this.dialog.mainAction = function() {
                        if (file.isNew) {
                            app.inputSurat.field.files.splice(index, 1);
                        } else {
                            file.isDeleted = true;
                        }

                        app.dialog.visible = false;
                        app.inputSurat.visible = true;
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                showInputAkun: function() {
                    this.sidebar.visible = false;
                    this.inputAkun.visible = true;
                    this.inputAkun.isNew = true;
                    this.inputAkun.error.visible = false;
                    this.inputAkun.field.id = 0;
                    this.inputAkun.field.nama = '';
                    this.inputAkun.field.email = '';
                    this.inputAkun.field.jabatan = '';
                    this.inputAkun.field.telepon = '';
                    this.inputAkun.field.admin = 0;
                    this.inputAkun.field.penginput = 0;

                    this.$nextTick(function() {
                        this.$refs.txtNamaAkun.focus();
                    });
                },
                showEditAkun: function(akun, index) {
                    this.inputAkun.visible = true;
                    this.inputAkun.isNew = false;
                    this.inputAkun.error.visible = false;
                    this.inputAkun.field.id = akun.id;
                    this.inputAkun.field.nama = akun.nama;
                    this.inputAkun.field.email = akun.email;
                    this.inputAkun.field.jabatan = akun.jabatan;
                    this.inputAkun.field.telepon = akun.telepon;
                    this.inputAkun.field.admin = akun.admin;
                    this.inputAkun.field.penginput = akun.penginput;
                    this.inputAkun.field.index = index;

                    this.$nextTick(function() {
                        this.$refs.txtNamaAkun.focus();
                    });
                },
                showEditAkunAktif: function() {
                    var akun = {
                        id: this.sidebar.account.id,
                        nama: this.sidebar.account.nama,
                        email: this.sidebar.account.email,
                        jabatan: this.sidebar.account.jabatan,
                        telepon: this.sidebar.account.telepon,
                        admin: this.sidebar.account.admin,
                        penginput: this.sidebar.account.penginput
                    };

                    this.sidebar.visible = false;
                    this.showEditAkun(akun, -1);
                },
                showEditPassword: function() {
                    this.sidebar.visible = false;
                    this.editPassword.visible = true;
                    this.editPassword.isNew = true;
                    this.editPassword.error.visible = false;
                    this.editPassword.field.id = this.sidebar.account.id;
                    this.editPassword.field.passwordLama = '';
                    this.editPassword.field.password = '';
                    this.editPassword.field.ulangPassword = '';

                    this.$nextTick(function() {
                        this.$refs.txtPasswordLama.focus();
                    });
                },
                showDeleteAkun: function(akun, index) {
                    var dialogMessage = 'Yakin ingin menghapus akun dengan nama ' + akun.nama + ' ?';
                    if (this.sidebar.account.id === akun.id) {
                        dialogMessage += ' Setelah dihapus, anda harus login kembali.';
                        index = -1;
                    }

                    this.dialog.visible = true;
                    this.dialog.title = 'Hapus Akun';
                    this.dialog.message = dialogMessage;
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;
                        axios.delete('/api/account/' + akun.id)
                            .then(function() {
                                if (index === -1) {
                                    app.logout();
                                    return;
                                }

                                app.pageList.item.splice(index, 1);
                                app.dialog.loading = false;
                                app.closeDialog();
                            })
                            .catch(function(error) {
                                var message = error.response ? error.response.data : error.message;

                                app.dialog.loading = false;
                                app.dialog.title = 'Error';
                                app.dialog.message = 'Gagal menghapus data akun. ' + message;
                                app.dialog.subCaption = '';
                                app.dialog.mainCaption = 'OK';
                                app.dialog.mainAction = app.closeDialog;

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                showDialogDisposisi: function(parent) {
                    this.dialogDisposisi.visible = true;
                    this.dialogDisposisi.error.visible = false;
                    this.dialogDisposisi.field.parentId = parseInt(parent, 10) | 0;
                    this.dialogDisposisi.field.tujuanId = 0;
                    this.dialogDisposisi.field.tujuan = '';
                    this.dialogDisposisi.field.deskripsi = '';

                    this.$nextTick(function() {
                        this.$refs.txtNamaTujuan.focus();
                    });
                },
                showDialogDiarsip: function() {
                    this.dialog.visible = true;
                    this.dialog.title = 'Arsipkan Surat';
                    this.dialog.message = 'Yakin ingin mengarsipkan surat ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;

                        var id = parseInt(app.pageDetail.disposisi.id, 10) | 0,
                            suratId = parseInt(app.pageDetail.surat.id, 10) | 0;

                        axios.post('/api/diarsip', {
                                id: id,
                                suratId: suratId
                            })
                            .then(function() {
                                var index = app.pageList.selected;

                                app.pageList.item[index].status = 1;
                                app.dialog.loading = false;
                                app.closeDialog();
                                app.closePageDetail();
                                app.selectSurat(index);
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.loading = false;
                                app.dialog.title = 'Error';
                                app.dialog.message = 'Gagal mengarsipkan surat. ' + message;
                                app.dialog.subCaption = '';
                                app.dialog.mainCaption = 'OK';
                                app.dialog.subAction = function() {
                                    app.dialog.visible = false;
                                };
                                app.dialog.mainAction = function() {
                                    app.dialog.visible = false;
                                };

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                showDialogDitindak: function() {
                    this.dialog.visible = true;
                    this.dialog.title = 'Tindaklanjuti Surat';
                    this.dialog.message = 'Yakin ingin menindaklanjuti surat ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;

                        var id = parseInt(app.pageDetail.disposisi.id, 10) | 0,
                            suratId = parseInt(app.pageDetail.surat.id, 10) | 0;

                        axios.post('/api/ditindak', {
                                id: id,
                                suratId: suratId
                            })
                            .then(function() {
                                var index = app.pageList.selected;

                                app.pageList.item[index].status = 2;
                                app.dialog.loading = false;
                                app.closeDialog();
                                app.closePageDetail();
                                app.selectSurat(index);
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.loading = false;
                                app.dialog.title = 'Error';
                                app.dialog.message = 'Gagal menindaklanjuti surat. ' + message;
                                app.dialog.subCaption = '';
                                app.dialog.mainCaption = 'OK';
                                app.dialog.subAction = function() {
                                    app.dialog.visible = false;
                                };
                                app.dialog.mainAction = function() {
                                    app.dialog.visible = false;
                                };

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                showDialogLogout: function() {
                    this.dialog.visible = true;
                    this.dialog.title = 'Log Out';
                    this.dialog.message = 'Yakin ingin log out dari aplikasi ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.mainAction = this.logout;
                    this.dialog.subAction = function() {
                        app.dialog.visible = false;
                    };
                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                closeDialog: function() {
                    if (this.dialog.loading) return;

                    if (this.inputSurat.visible && this.inputSurat.suggestion.item.length > 0) {
                        this.inputSurat.suggestion = [];
                        return;
                    }

                    this.inputSurat.visible = false;
                    this.inputAkun.visible = false;
                    this.dialogDisposisi.visible = false;
                    this.dialogDiarsip.visible = false;
                    this.dialogDitindak.visible = false;
                    this.editPassword.visible = false;
                    this.dialog.visible = false;
                    this.dialog.loading = false;
                },
                simpanSurat: function() {
                    // If still loading, stop
                    if (this.dialog.loading) return;

                    // Validate input
                    if (this.inputSurat.field.nomor === '') {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Nomor surat harus diisi';
                        return;
                    }

                    if (this.inputSurat.field.perihal === '') {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Perihal surat harus diisi';
                        return;
                    }

                    if (this.inputSurat.field.sumber === '') {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Sumber surat harus diisi';
                        return;
                    }

                    if (this.inputSurat.isNew && this.inputSurat.field.tujuanId === 0) {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Tujuan surat harus diisi';
                        return;
                    }

                    var tanggalSurat = moment(this.inputSurat.field.tanggal, 'DD-MM-YYYY');
                    if (!tanggalSurat.isValid()) {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Tanggal surat harus format tanggal/bulan/tahun';
                        return;
                    }

                    var waktuTerima = moment(this.inputSurat.field.waktuTerima, 'DD-MM-YYYY HH:mm:ss');
                    if (!waktuTerima.isValid()) {
                        this.inputSurat.error.visible = true;
                        this.inputSurat.error.message = 'Waktu terima surat harus format tanggal/bulan/tahun jam:menit:detik';
                        return;
                    }

                    // Show dialog confirmation
                    this.inputSurat.visible = false;
                    this.dialog.visible = true;
                    this.dialog.title = this.inputSurat.isNew ? 'Surat Baru' : 'Edit Surat';
                    this.dialog.message = this.inputSurat.isNew ? 'Yakin ingin menyimpan surat baru ?' : 'Yakin ingin memperbarui data surat ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.inputSurat.visible = true;
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;
                        var method = app.inputSurat.isNew ? 'post' : 'put';

                        var formData = new FormData();
                        formData.append('id', app.inputSurat.field.id);
                        formData.append('nomor', app.inputSurat.field.nomor);
                        formData.append('perihal', app.inputSurat.field.perihal);
                        formData.append('sumber', app.inputSurat.field.sumber);
                        formData.append('tujuanId', app.inputSurat.field.tujuanId);
                        formData.append('tanggal', tanggalSurat.format('YYYY-MM-DD'));
                        formData.append('waktuTerima', waktuTerima.format('YYYY-MM-DD HH:mm:ss'));
                        formData.append('prioritas', app.inputSurat.field.prioritas);

                        app.inputSurat.field.files.forEach(function(file) {
                            if (file.isNew) {
                                formData.append('files', file.blob, file.blob.name);
                            }

                            if (file.isDeleted) {
                                formData.append('deleted', file.name);
                            }
                        });

                        axios({
                                method: method,
                                url: '/api/surat',
                                data: formData,
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            })
                            .then(function() {
                                app.dialog.loading = false;

                                if (!app.inputSurat.isNew) {
                                    var index = app.pageList.selected;

                                    app.pageList.item[index].nomor = app.inputSurat.field.nomor;
                                    app.pageList.item[index].perihal = app.inputSurat.field.perihal;
                                    app.pageList.item[index].sumber = app.inputSurat.field.sumber;
                                    app.pageList.item[index].tanggal = tanggalSurat;
                                    app.pageList.item[index].waktuTerima = waktuTerima;
                                    app.pageList.item[index].prioritas = parseInt(app.inputSurat.field.prioritas, 10) | 0;

                                    app.closeDialog();
                                    app.closePageDetail();
                                    app.selectSurat(index);
                                } else {
                                    app.closeDialog();
                                    app.loadListItem();
                                }
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.visible = false;
                                app.dialog.loading = false;
                                app.inputSurat.visible = true;
                                app.inputSurat.error.visible = true;
                                app.inputSurat.error.message = message;

                                return;
                            });
                    };

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                simpanAkun: function() {
                    // If still loading, stop
                    if (this.dialog.loading) return;

                    // Validate input
                    if (this.inputAkun.field.nama === '') {
                        this.inputAkun.error.visible = true;
                        this.inputAkun.error.message = 'Nama harus diisi';
                        return;
                    }

                    if (this.inputAkun.field.email === '') {
                        this.inputAkun.error.visible = true;
                        this.inputAkun.error.message = 'Email harus diisi';
                        return;
                    }

                    if (this.inputAkun.field.jabatan === '') {
                        this.inputAkun.error.visible = true;
                        this.inputAkun.error.message = 'Jabatan harus diisi';
                        return;
                    }

                    if (this.inputAkun.field.telepon.match(/\D/g)) {
                        this.inputAkun.error.visible = true;
                        this.inputAkun.error.message = 'Nomor telepon hanya boleh terdiri atas angka';
                        return;
                    }

                    // Show dialog confirmation
                    var dialogMessage = this.inputAkun.isNew ? 'Yakin ingin menyimpan data akun baru ?' : 'Yakin ingin memperbarui data akun ?';
                    if (this.inputAkun.field.id === this.sidebar.account.id) {
                        dialogMessage += ' Setelah edit dilakukan, anda harus login kembali.';
                        this.inputAkun.field.index = -1;
                    }

                    this.inputAkun.visible = false;
                    this.dialog.visible = true;
                    this.dialog.title = this.inputAkun.isNew ? 'Akun Baru' : 'Edit Akun';
                    this.dialog.message = dialogMessage;
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.inputAkun.visible = true;
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;
                        var method = app.inputAkun.isNew ? 'post' : 'put';
                        axios({
                                method: method,
                                url: '/api/account',
                                data: {
                                    id: app.inputAkun.field.id,
                                    nama: app.inputAkun.field.nama,
                                    email: app.inputAkun.field.email,
                                    jabatan: app.inputAkun.field.jabatan,
                                    telepon: app.inputAkun.field.telepon,
                                    admin: parseInt(app.inputAkun.field.admin, 10) | 0,
                                    penginput: parseInt(app.inputAkun.field.penginput, 10) | 0
                                }
                            })
                            .then(function() {
                                if (!app.inputAkun.isNew) {
                                    var index = app.inputAkun.field.index;

                                    if (index === -1) {
                                        app.logout();
                                        return;
                                    }

                                    app.pageList.item[index].nama = app.inputAkun.field.nama;
                                    app.pageList.item[index].email = app.inputAkun.field.email;
                                    app.pageList.item[index].jabatan = app.inputAkun.field.jabatan;
                                    app.pageList.item[index].telepon = app.inputAkun.field.telepon;
                                    app.pageList.item[index].admin = parseInt(app.inputAkun.field.admin, 10) | 0;
                                    app.pageList.item[index].penginput = parseInt(app.inputAkun.field.penginput, 10) | 0;

                                    app.dialog.loading = false;
                                    app.closeDialog();
                                    return;
                                }

                                app.dialog.loading = false;
                                app.closeDialog();
                                app.loadListItem();
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.visible = false;
                                app.dialog.loading = false;
                                app.inputAkun.visible = true;
                                app.inputAkun.error.visible = true;
                                app.inputAkun.error.message = message;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                simpanPassword: function() {
                    // If still loading, stop
                    if (this.dialog.loading) return;

                    // Validate input
                    if (this.editPassword.field.password === '') {
                        this.editPassword.error.visible = true;
                        this.editPassword.error.message = 'Password baru harus diisi';
                        return;
                    }

                    if (this.editPassword.field.ulangPassword !== this.editPassword.field.password) {
                        this.editPassword.error.visible = true;
                        this.editPassword.error.message = 'Password yang diulang tidak cocok';
                        return;
                    }

                    // Show dialog confirmation
                    this.editPassword.visible = false;
                    this.dialog.visible = true;
                    this.dialog.title = 'Ubah Password';
                    this.dialog.message = 'Yakin ingin mengubah password ? Setelah selesai, anda harus login kembali.';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.editPassword.visible = true;
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;
                        axios.post('/api/account/password', {
                                id: app.editPassword.field.id,
                                passwordLama: app.editPassword.field.passwordLama,
                                password: app.editPassword.field.password
                            })
                            .then(function() {
                                app.dialog.loading = false;
                                app.logout();
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.visible = false;
                                app.dialog.loading = false;
                                app.editPassword.visible = true;
                                app.editPassword.error.visible = true;
                                app.editPassword.error.message = message;

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                selectSurat: function(idx) {
                    if (idx === this.pageList.selected) {
                        return;
                    }

                    var surat = this.pageList.item[idx];

                    this.pageList.selected = idx;
                    this.pageList.error.visible = false;

                    this.pageDetail.surat.id = '';
                    this.pageDetail.visible = true;
                    this.pageDetail.loading = true;

                    var url = '/api/surat/id/' + surat.id;
                    if (this.sidebar.selected === 5) url += '?kelola';

                    axios(url).then(function(response) {
                        app.pageDetail.loading = false;
                        app.setDetailSurat(response.data);

                        app.$nextTick(function() {
                            var detailArea = document.getElementById('detail-content');
                            Ps.initialize(detailArea);
                        });
                    }).catch(function(error) {
                        var message;
                        if (error.response) message = error.response.data;
                        else message = error.message;

                        app.pageList.selected = 0;
                        app.pageDetail.loading = false;
                        app.pageDetail.visible = false;
                        app.pageList.error.visible = true;
                        app.pageList.error.message = message;
                    });
                },
                setDetailSurat: function(data) {
                    this.pageDetail.surat.id = data.surat.id;
                    this.pageDetail.surat.nomor = data.surat.nomor;
                    this.pageDetail.surat.perihal = data.surat.perihal;
                    this.pageDetail.surat.sumber = data.surat.sumber;
                    this.pageDetail.surat.tujuan = data.surat.tujuan;
                    this.pageDetail.surat.jabatan = data.surat.jabatan;
                    this.pageDetail.surat.tanggal = data.surat.tanggal;
                    this.pageDetail.surat.waktuTerima = data.surat.waktuTerima;
                    this.pageDetail.surat.prioritas = data.surat.prioritas;
                    this.pageDetail.surat.status = data.surat.status;

                    this.pageDetail.disposisi.id = data.disposisi.id;
                    this.pageDetail.disposisi.parentId = data.disposisi.parentId;
                    this.pageDetail.disposisi.sumberId = data.disposisi.sumberId;
                    this.pageDetail.disposisi.sumber = data.disposisi.sumber;
                    this.pageDetail.disposisi.jabatan = data.disposisi.jabatan;
                    this.pageDetail.disposisi.waktu = data.disposisi.waktu;
                    this.pageDetail.disposisi.status = data.disposisi.status;
                    this.pageDetail.disposisi.deskripsi = data.disposisi.deskripsi;

                    this.pageDetail.files = data.files;
                    this.pageDetail.timeline = data.timeline;

                    var indexSurat = this.pageList.selected;
                    if (this.pageList.item[indexSurat].read === 1) return;

                    this.pageList.item[indexSurat].read = 1;

                    this.sidebar.item[0].count -= 1;
                    if (data.disposisi.status === 0) this.sidebar.item[1].count -= 1;
                    else if (data.disposisi.status === 1) this.sidebar.item[2].count -= 1;
                    else if (data.disposisi.status === 2) this.sidebar.item[3].count -= 1;
                    else if (data.disposisi.status === 3) {
                        this.sidebar.item[2].count -= 1;
                        this.sidebar.item[3].count -= 1;
                    }
                },
                closePageDetail: function() {
                    this.pageList.selected = '';
                    this.pageDetail.visible = false;
                },
                showLightbox: function(name) {
                    this.lightbox.visible = true;
                    this.lightbox.loading = true;
                    this.lightbox.error = false;
                    this.lightbox.data = '/api/surat/image/' + name;
                },
                closeLightbox: function() {
                    if (this.lightbox.loading) return;
                    this.lightbox.visible = false;
                },
                lightboxLoaded: function() {
                    this.lightbox.loading = false;
                    this.$refs.lightbox.focus();
                },
                lightboxError: function() {
                    this.lightbox.loading = false;
                    this.lightbox.error = true;
                    this.$refs.lightbox.focus();
                },
                getTujuanSuggestion: _.debounce(function(e) {
                    var value = e.target.value.trim();
                    this.inputSurat.error.visible = false;
                    this.inputSurat.field.tujuan = value;
                    this.inputSurat.field.tujuanId = 0;
                    this.inputSurat.suggestion.item = [];

                    if (value === '') return;

                    this.inputSurat.suggestion.loading = true;
                    axios('/api/account?keyword=' + encodeURI(value))
                        .then(function(response) {
                            app.inputSurat.suggestion.loading = false;
                            app.inputSurat.suggestion.item = response.data.item;
                        })
                        .catch(function(response) {
                            var message;
                            if (error.response) message = error.response.data;
                            else message = error.message;

                            app.inputSurat.suggestion.loading = false;
                            app.inputSurat.error.visible = true;
                            app.inputSurat.error.message = message;
                        });
                }, 300),
                closeTujuanSuggestion: function() {
                    if (this.inputSurat.suggestion.loading || this.inputSurat.suggestion.item.length === 0) return;
                    this.inputSurat.suggestion.item = [];
                },
                selectTujuanSuggestion: function(idx) {
                    var index = parseInt(idx, 10) | 0,
                        account = this.inputSurat.suggestion.item[index];

                    this.inputSurat.field.tujuanId = account.id;
                    this.inputSurat.field.tujuan = account.nama;

                    this.$refs.txtTanggalSurat.focus();
                },
                focusTujuanSuggestion: function(idx) {
                    if (idx < 0 || idx >= this.$refs.tujuanSuggestionItem.length) return;
                    this.$refs.tujuanSuggestionItem[idx].focus();
                },
                getDisposisiSuggestion: _.debounce(function(e) {
                    var value = e.target.value.trim();
                    this.dialogDisposisi.error.visible = false;
                    this.dialogDisposisi.field.tujuan = value;
                    this.dialogDisposisi.field.tujuanId = 0;
                    this.dialogDisposisi.suggestion.item = [];

                    if (value === '') return;

                    this.dialogDisposisi.suggestion.loading = true;
                    axios('/api/account?keyword=' + encodeURI(value))
                        .then(function(response) {
                            app.dialogDisposisi.suggestion.loading = false;
                            app.dialogDisposisi.suggestion.item = response.data.item;
                        })
                        .catch(function(response) {
                            var message;
                            if (error.response) message = error.response.data;
                            else message = error.message;

                            app.dialogDisposisi.suggestion.loading = false;
                            app.dialogDisposisi.error.visible = true;
                            app.dialogDisposisi.error.message = message;
                        });
                }, 300),
                closeDisposisiSuggestion: function() {
                    if (this.dialogDisposisi.suggestion.loading || this.dialogDisposisi.suggestion.item.length === 0) return;
                    this.dialogDisposisi.suggestion.item = [];
                },
                selectDisposisiSuggestion: function(idx) {
                    var index = parseInt(idx, 10) | 0,
                        account = this.dialogDisposisi.suggestion.item[index];

                    if (account.id === this.sidebar.account.id) {
                        app.dialogDisposisi.error.visible = true;
                        app.dialogDisposisi.error.message = 'Tidak bisa mendisposisi ke diri sendiri';
                        return;
                    }

                    this.dialogDisposisi.field.tujuanId = account.id;
                    this.dialogDisposisi.field.tujuan = account.nama;

                    this.$refs.txtKeteranganDisposisi.focus();
                },
                focusDisposisiSuggestion: function(idx) {
                    if (idx < 0 || idx >= this.$refs.disposisiSuggestionItem.length) return;
                    this.$refs.disposisiSuggestionItem[idx].focus();
                },
                simpanDisposisi: function() {
                    // Validate input
                    if (this.dialogDisposisi.field.tujuanId === 0) {
                        this.dialogDisposisi.error.visible = true;
                        this.dialogDisposisi.error.message = 'Tujuan disposisi harus dipilih dari daftar yang tersedia';
                        return;
                    }

                    // Show dialog confirmation
                    this.dialogDisposisi.visible = false;
                    this.dialog.visible = true;
                    this.dialog.title = 'Disposisi Surat';
                    this.dialog.message = 'Yakin ingin mendisposisikan surat ?';
                    this.dialog.subCaption = 'Tidak';
                    this.dialog.mainCaption = 'Ya';
                    this.dialog.subAction = function() {
                        app.dialogDisposisi.visible = true;
                        app.dialog.visible = false;
                    };
                    this.dialog.mainAction = function() {
                        app.dialog.loading = true;

                        var suratId = parseInt(app.pageDetail.surat.id, 10) | 0;

                        axios.post('/api/disposisi', {
                                suratId: suratId,
                                parentId: app.dialogDisposisi.field.parentId,
                                tujuanId: app.dialogDisposisi.field.tujuanId,
                                deskripsi: app.dialogDisposisi.field.deskripsi
                            })
                            .then(function() {
                                var index = app.pageList.selected;

                                app.dialog.loading = false;
                                app.closeDialog();
                                app.closePageDetail();
                                app.selectSurat(index);
                            })
                            .catch(function(error) {
                                var message;
                                if (error.response) message = error.response.data;
                                else message = error.message;

                                app.dialog.visible = false;
                                app.dialog.loading = false;
                                app.dialogDisposisi.visible = true;
                                app.dialogDisposisi.error.visible = true;
                                app.dialogDisposisi.error.message = message;

                                return;
                            });
                    }

                    this.$nextTick(function() {
                        this.$refs.mainDialogButton.focus();
                    });
                },
                filterPageList: _.debounce(function(e) {
                    var value = e.target.value.trim();
                    this.loadListItem(value);
                }, 300),
                paginationChange: _.debounce(function(e) {
                    var value = e.target.value.trim(),
                        pageNumber = parseInt(value, 10) || 1;

                    this.loadListItem(this.pageList.keyword, pageNumber);
                }, 300)
            }
        });

        var sidebarLinkContainer = document.getElementById('link-container');
        Ps.initialize(sidebarLinkContainer);

        document.getElementById('app').removeAttribute('style');

        document.onkeypress = function(e) {
            if (app.loadingOverlayVisible) {
                e.preventDefault();
            }
        };

        app.loadListItem();

    </script>
</body>

</html>
